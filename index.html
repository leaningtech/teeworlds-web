<!DOCTYPE html>
<html lang="en" style="height:100%;">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no,initial-scale=1.0,maximum-scale=1.0,minimal-ui" />
		<link rel="icon" type="image/png" href=".icon.png">
		<title>Teeworlds Server - Web edition</title>
		<style>
			table {
				border-collapse: collapse;
			}
			th, td {
				padding: 8px;
				text-align: left;
				border-bottom: 1px solid #ddd;
			}
			tr:hover {background-color:#f5f5f5;}
			td > a {
				width: 100%;
				height: 100%;
				display: block;
			}

			label {
				display: block;
			}
			#content {
				display: flex;
				flex-direction: row;
				justify-content: space-between;
				width: 100%;
			}
		</style>
	</head>
	<body>
		<h1>Teeworlds - Web Edition</h1>
		<div id="content">
			<div id="game">
				<div id="conf">
					<h3>Create New Server</h3>
					<label for="name">Server Name</label>
					<input id="name" type="text" required></input>
					<br/>
					<label for="map">Map</label>
					<select id="map">
						<option value="dm1">dm1</option>
						<option value="dm2">dm2</option>
						<option value="dm3">dm3</option>
						<option value="dm6">dm6</option>
						<option value="dm7">dm7</option>
						<option value="dm8">dm8</option>
						<option value="dm9">dm9</option>
					</select>
					<br/>
					<select id="gametype" hidden>
						<option value="dm">dm</option>
						<option value="ctf">ctf</option>
						<option value="tdm">tdm</option>
						<option value="lms">lms</option>
						<option value="lts">lts</option>
					</select>
					<br/>
					<label for="scorelimit">Score Limit</label>
					<input id="scorelimit" type="number" min="1" value="20"></input>
					<br/>
					<label for="timelimit">Time Limit</label>
					<input id="timelimit" type="number" min="0" value="0"></input>
					<br/>
				</div>
				<input id="start" type="button" value="Start new server"></input>
				<br/>
				<div>
					<h3>Active Servers</h3>
					<table id="serverlist">
						<tr class="tableHeader">
							<th>Server Name</th>
							<th>Map</th>
							<th>Players</th>
							<th>Region</th>
							<th>Latency</th>
						</tr>
					</table>
				</div>
			</div>
			<div id="descr">
				<h3>Description</h3>
				<p>
					<a href="https://www.teeworlds.com/">Teeworlds</a> is a retro multiplayer shooter game.
					<br/>
					This unofficial version runs in your browser thanks to the <a href="https://www.leaningtech.com/cheerp/">Cheerp compiler</a>.
				</p>
				<p>
					On the right you can create a new server, or join an existing one.
					<br/>
					In either case, click on a server link to play.
					<br/>
					Copy it and share it with your friends so they can join the same server easily!
				</p>
				<p>
					If you create your own server, please don't close the tab while you are still playing.
					<br/>
					The server runs in your browser just as the client, and they communicate directly through WebRTC.
				</p>
			</div>
		</div>

		<script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-database.js"></script>
		<script src="webrtc.js"></script>
		<script>
			var startElem = document.getElementById("start");
			let confElem = document.getElementById("conf");
			startElem.onclick=function()
			{
				let conf = {};
				for (let i = 0; i < confElem.children.length; i++)
				{
					let c = confElem.children[i];
					if (c.tagName == "INPUT" || c.tagName == "SELECT")
					{
						conf[c.id] = c.value;
						c.disabled = true;
					}
				}
				startElem.disabled = true;
				if (start.promise !== undefined)
				{
					start.promise.then(function() {
						start(conf);
					});
				}
				else
				{
					start(conf);
				}
			};
			var table = document.getElementById("serverlist");
			var servers = [];
			function makeTr(row)
			{
				var tr = document.createElement("tr");
				var cols = ["name", "map", "players", "continent", "latency"];
				cols.forEach(function(n) {
					var td = document.createElement("td");
					var a = document.createElement("a");
					a.href = "/teeworlds.html#"+row.key;
					a.setAttribute("target", "_blank");
					td.appendChild(a);
					tr.appendChild(td);
				});
				updateTr(tr, row);
				return tr;
			}
			function updateTr(tr, row)
			{
				var cols = ["name", "map", "players", "continent", "latency"];
				cols.forEach(function(n, i) {
					var td = tr.children[i];
					var a = td.children[0];
					if (a.innerText != row[n])
						a.innerText = row[n];
				});
			}
			function addServerRow(row)
			{
				var idx = 0;
				for (; idx < servers.length; idx++)
				{
					if (servers[idx].latency >= row.latency)
						break;
				}
				servers.splice(idx, 0, row);
				table.insertBefore(makeTr(row), table.children[idx+1]);
			}
			function updateServerRow(row)
			{
				var idx = 0;
				for (; idx < servers.length; idx++)
				{
					if (servers[idx].key == row.key)
						break;
				}
				if (idx == servers.length)
					return;
				var tr = table.children[idx+1];
				updateTr(tr, row);
				servers[idx] = row;
			}
			function removeServerRow(key)
			{
				var idx = 0;
				for (; idx < servers.length; idx++)
				{
					if (servers[idx].key == key)
						break;
				}
				if (idx == servers.length)
					return;
				var tr = table.children[idx+1];
				tr.remove();
				servers.splice(idx, 1);
			}
		</script>
		<script src="teeworlds_srv.js"></script>
	</body>
</html>
