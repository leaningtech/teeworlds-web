<!DOCTYPE html>
<html lang="en" style="height:100%;">
	<head>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
		<link rel="stylesheet" type="text/css" href="assets/styles/main.css">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no,initial-scale=1.0,maximum-scale=1.0,minimal-ui" />
		<link rel="icon" type="image/png" href="/assets/images/favicon.png">
		<title>Teeworlds Web</title>
	</head>

	<body>
		<div id="header">
			<span><h1>Teeworlds - Web Edition</h1></span>
		</div>
		<div id="content">
				<br>
				<div id="servers">
					<br>
					<h3>Active Servers</h3>
					<br>
					<div id="server-overflow">
					<table id="serverlist" class="table table-striped table-dark">
						<tr class="tableHeader">
							<th>Server Name</th>
							<th>Map</th>
							<th>Players</th>
							<th>Region</th>
							<th>Latency</th>
						</tr>
					</table>
					</div>
					<a id="server-link" href="#conf" class="btn btn-primary">Create a Server!</a>
				</div>
				<div id="descr">
						<a href="https://www.teeworlds.com/" target="_blank"><img id="teeworlds" src="assets/images/teeworlds.png"></a>
					<p>
						<a href="https://www.teeworlds.com/" target="_blank">Teeworlds</a> is a retro multiplayer shooter game.
						<br>
						This unofficial version runs in your browser thanks to the <a href="https://www.leaningtech.com/cheerp/" target="_blank">Cheerp compiler</a>.
					<br>For more information and issue tracking, please visit our <a href="https://github.com/leaningtech/teeworlds-web" target="_blank">Github page</a>.
					</p><br>
					<p>
						Below, you can create a new server, or join an existing one.
						<br/>
						In either case, click on a server link to play.
						<br/>
						Copy it and share it with your friends so they can join the same server easily!
					</p><br>
					<p>
						If you create your own server, please don't close the tab while you are still playing.
						<br/>
						The server runs in your browser just as the client, and they communicate directly through WebRTC.
					</p>
					<a href= "https://www.leaningtech.com/cheerp/" target="_blank"><img id="cheerp" src="assets/images/cheerp.png"></a>
				</div>
				<div id="conf">
					<br>
					<h3>Create New Server</h3>
					<br>
					<div id="block">
					<label for="name">Server Name: </label>
					<input id="name" class="form-control stubbed-input" type="text" placeholder="New Server" required></input>
					</div>
					<div id="block">
						<label for="map">Map: </label>
						<select class="custom-select custom-select-sm mb-3 stubbed-input" id="map">
							<option value="dm1">dm1</option>
							<option value="dm2">dm2</option>
							<option value="dm3">dm3</option>
							<option value="dm6">dm6</option>
							<option value="dm7">dm7</option>
							<option value="dm8">dm8</option>
							<option value="dm9">dm9</option>
						</select>
					</div>
					<select id="gametype" hidden>
						<option value="dm">dm</option>
						<option value="ctf">ctf</option>
						<option value="tdm">tdm</option>
						<option value="lms">lms</option>
						<option value="lts">lts</option>
					</select>
					<div id="block">
						<label for="scorelimit">Score Limit: </label>
						<input id="scorelimit" class="form-control stubbed-input" type="number" min="1" value="20"></input>
					</div>
					<div id="block">
						<label for="timelimit">Time Limit: </label>
						<input id="timelimit" class="form-control stubbed-input" type="number" min="1" value="1"></input>
					</div>
				<input id="start" type="button" class="btn btn-primary" value="Create"></input>
				</div>
			</div>
				<div id="footer">
					<a href= "https://www.leaningtech.com/" target="_blank"><img id='logo' src='assets/images/leaningtech.png'></a><br>
			Leaning Technologies Limited © 2013-2019. All Rights Reserved. Cheerp® is a registered trademark of Leaning Technologies Limited.
			<br /><span>Cheerp and CheerpJ logos are based on the HTML5 logo by <a style="color: white;" href="http://www.w3.org/" target="_blank"><abbr title="World Wide Web Consortium">W3C</abbr></a> (<a style="color: white;" href="https://creativecommons.org/licenses/by/3.0/"i target="_blank">license</a>)</span>
			<br /><a href="https://leaningtech.com/about/privacy/index.html" target="_blank" style="color: white;">Privacy and cookie policy</a>
		</div>

		<script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/5.0.4/firebase-database.js"></script>
		<script src="webrtc.js"></script>
		<script>
			var startElem = document.getElementById("start");
			let confElem = document.getElementById("conf");
			function getValueAndDisable(elemId)
			{
				var e = document.getElementById(elemId);
				e.disabled = true;
				return e.value;
			}
			startElem.onclick=function()
			{
				let conf = {};
				conf.name = getValueAndDisable("name");
				conf.map = getValueAndDisable("map");
				conf.gametype = getValueAndDisable("gametype");
				conf.timelimit = getValueAndDisable("timelimit");
				conf.scorelimit = getValueAndDisable("scorelimit");
				startElem.disabled = true;
				server-link.disabled = true;
				if (start.promise !== undefined)
				{
					start.promise.then(function() {
						start(conf);
					});
				}
				else
				{
					start(conf);
				}
			};
			var table = document.getElementById("serverlist");
			var servers = [];
			function makeTr(row)
			{
				var tr = document.createElement("tr");
				var cols = ["name", "map", "players", "continent", "latency"];
				cols.forEach(function(n) {
					var td = document.createElement("td");
					var a = document.createElement("a");
					a.href = "/teeworlds.html#"+row.key;
					a.setAttribute("target", "_blank");
					td.appendChild(a);
					tr.appendChild(td);
				});
				updateTr(tr, row);
				return tr;
			}
			function updateTr(tr, row)
			{
				var cols = ["name", "map", "players", "continent", "latency"];
				cols.forEach(function(n, i) {
					var td = tr.children[i];
					var a = td.children[0];
					var newText = row[n];
					if(n == "latency")
					{
						var l = +newText;
						if(l < 100)
						{
							newText = "Good";
							a.style.color = "green";
						}
						else if(l < 150)
						{
							newText = "Ok";
							a.style.color = "orange";
						}
						else
						{
							newText = "Bad";
							a.style.color = "red";
						}
					}
					if (a.innerText != newText)
						a.innerText = newText;
				});
			}
			function addServerRow(row)
			{
				var idx = 0;
				for (; idx < servers.length; idx++)
				{
					if (servers[idx].latency >= row.latency)
						break;
				}
				servers.splice(idx, 0, row);
				table.insertBefore(makeTr(row), table.children[idx+1]);
			}
			function updateServerRow(row)
			{
				var idx = 0;
				for (; idx < servers.length; idx++)
				{
					if (servers[idx].key == row.key)
						break;
				}
				if (idx == servers.length)
					return;
				var tr = table.children[idx+1];
				updateTr(tr, row);
				servers[idx] = row;
			}
			function removeServerRow(key)
			{
				var idx = 0;
				for (; idx < servers.length; idx++)
				{
					if (servers[idx].key == key)
						break;
				}
				if (idx == servers.length)
					return;
				var tr = table.children[idx+1];
				tr.remove();
				servers.splice(idx, 1);
			}
		</script>
		<script src="teeworlds_srv.js"></script>
	</body>
</html>
